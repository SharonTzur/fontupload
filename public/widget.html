<!DOCTYPE html>
<html>
<head>
	<script>
		(function ()
		{
			var wf = document.createElement('script');
			wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
			'://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js';
			wf.type = 'text/javascript';
			wf.async = 'true';
			var s = document.getElementsByTagName('script')[0];
			s.parentNode.insertBefore(wf, s);
		})();
	</script>
	<!--Wix-->
	<script type="text/javascript" src="http://sslstatic.wix.com/services/js-sdk/1.24.0/js/Wix.js"></script>
	<!--jQuery -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<!--Utils-->
	<script src="utils.js"></script>
	<script src="fonts.js"></script>
	<script src="upload.js"></script>
	<script src="globals.js"></script>
	<!--CSS -->
	<link rel="stylesheet" type="text/css" href="widget.css">
	<script>

		var SERVER_URL = 'http://84.109.234.163:3020';
		var loadedFonts = [];


		var instanceId = 'Local-InstnaceId-rotem931',
		    compId     = 'Local-compId3-rotem931';
//		var instanceId = Wix.Utils.getInstanceId(),
//				compId = Wix.Utils.getCompId();

		$.ajax({
			type   : "POST",
			url    : SERVER_URL + "/load/",
			data   : {
				instanceId: instanceId,
				compId    : compId
			},
			success: function (data, status, jqXHR)
			{
				{
					console.log('WIDGET: Loaded Data: ' + JSON.stringify(data));
//					refreshLocalWidget(data, $('#textBox'));
//					refreshLocalWidget(data, $('.redactor-editor'));
					gotCode (data.p.code);
					if (data.list)
							$.each(data.list, function (i, font) {
								var fontFamily = font.fileName.split('.')[0];
								upload.loadUploadedFont(font.url, fontFamily , null, function () {
									loadedFonts.push(fontFamily);
								});
						})
				}
			}
		});

		function gotCode (code, uploadedFonts) {

			var fontObjArray = checkCodeForFonts ($(code));
			debugger;
			loadedFonts =  loadedFonts.concat(fontObjArray.fontsName);
			$('#textBox').html(code);
			for (var i = 0; i < fontObjArray.fontsObj.length; i++) {
				if  (fontObjArray.fontsObj[i])
					loadAllFontVariants(fontObjArray.fontsObj[i],null,null,null,null, fontObjArray.idx[i]);
				else
				{
					var font =  getObj (uploadedFonts, fontObjArray[i].fontsName);
					upload.loadUploadedFont(font.url, font.family , null, function () {
						loadedFonts.push(fontFamily);
					});
				}
			}

		}

		Wix.addEventListener(Wix.Events.SETTINGS_UPDATED, function (newSettings)
		{
			console.log('Widget: New settings received: ' + JSON.stringify(newSettings));
			getColor(newSettings.code, newSettings.uploadedFonts);
//			$('#textBox').html(data.p.code);

//			refreshLocalWidget(newSettings['settings'], $('#textBox'));
		});

		$(document).ready(function ()
		{
			buildAllFontsArray();
		});
	</script>

</head>
<body id="widgetBody">
<div class='textBox' id='textBox'></div>
</body></html>